/**
 * @fileoverview Firestore Security Rules for the Ward Dashboard application.
 *
 * Core Philosophy:
 * This ruleset employs a hierarchical role-based access control model.
 * The user with the email 'ginorojoj@gmail.com' is the designated 'administrator' with full rights.
 * An 'administrator' can create 'bishops'.
 * 'Bishops' can create 'counselors' and 'secretaries'.
 * New users can create their own user document upon registration.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /interviews/{interviewId}: Stores interview records.
 * - /bishopricMeetings/{meetingId}: Stores bishopric meeting records.
 * - /sacramentMeetings/{meetingId}: Stores sacrament meeting agendas.
 * - /logs/{logId}: Stores user action logs.
 * - /reuniones/{reunionId}: Stores general meeting records.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdministrator() {
        return request.auth.token.email == "ginorojoj@gmail.com";
    }

    function isBishop() {
      let data = getUserData(request.auth.uid);
      return data != null && data.role == 'bishop';
    }
    
    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Create: Allow if user is creating their own doc, if admin, or if bishop creating allowed roles.
      allow create: if isSignedIn() && 
                      (isOwner(userId) || 
                       isAdministrator() || 
                       (isBishop() && request.resource.data.role in ['counselor', 'secretary']));

      // Read: Any signed-in user can read any profile.
      allow get: if isSignedIn();
      // Read List: Any signed-in user can list all profiles.
      allow list: if isSignedIn();

      // Update: Admin can update any user. Bishops can update counselors/secretaries. Users can update their own profile (but not their role).
      allow update: if isSignedIn() && 
                      (isAdministrator() || 
                       (isBishop() && getUserData(userId).role in ['counselor', 'secretary']) || 
                       (isOwner(userId) && request.resource.data.role == resource.data.role));

      // Delete: Admin can delete any user. Bishops can delete counselors and secretaries.
      allow delete: if isSignedIn() && 
                      (isAdministrator() || (isBishop() && getUserData(userId).role in ['counselor', 'secretary']));
    }

    /**
     * @description Controls access to interview records.
     * @path /interviews/{interviewId}
     */
    match /interviews/{interviewId} {
      allow read, write: if isSignedIn();
    }
    
    /**
     * @description Controls access to meeting records.
     * @path /reuniones/{reunionId}
     */
    match /reuniones/{reunionId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Controls access to bishopric meeting records and their subcollections.
     * @path /bishopricMeetings/{meetingId}
     */
    match /bishopricMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /notes/{noteId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to sacrament meeting agenda records and their subcollections.
     * @path /sacramentMeetings/{meetingId}
     */
    match /sacramentMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /asuntosBarrio/{asuntoId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to log entries.
     * @path /logs/{logId}
     */
    match /logs/{logId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false;
    }
  }
}

    