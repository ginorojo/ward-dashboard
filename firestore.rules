/**
 * @fileoverview Firestore Security Rules for the Ward Dashboard application.
 *
 * Core Philosophy:
 * This ruleset employs a hybrid security model: user-ownership for profile data and role-based access control.
 * The user with the email 'ginorojoj@gmail.com' is designated as the 'bishop' with full administrative rights over user management.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /interviews/{interviewId}: Stores interview records.
 * - /bishopricMeetings/{meetingId}: Stores bishopric meeting records.
 * - /sacramentMeetings/{meetingId}: Stores sacrament meeting agendas.
 * - /logs/{logId}: Stores user action logs.
 *
 * Key Security Decisions:
 * - User data is strictly controlled. The bishop can manage all users. Other users can only manage their own profile.
 * - Collaborative data is accessible to all authenticated users.
 * - Logs can only be created.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isBishop() {
      // The user with this email is always considered a bishop.
      if (request.auth.token.email == "ginorojoj@gmail.com") {
        return true;
      }
      // Or if their role in the database is 'bishop'.
      let userRole = getUserData(request.auth.uid).role;
      return userRole == 'bishop';
    }

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Allow creation if the user is a bishop, or if the user is creating their own profile.
      allow create: if isSignedIn() && (isBishop() || isOwner(userId));
      // Allow reading if the user is a bishop or the owner of the profile.
      allow get: if isSignedIn() && (isBishop() || isOwner(userId));
      // Bishops can list all users.
      allow list: if isSignedIn() && isBishop();
      // Bishops can update any user. Users can update their own profile.
      // Nobody can change their own role or UID.
      allow update: if isSignedIn() && (isBishop() || (isOwner(userId) && request.resource.data.role == resource.data.role && request.resource.data.uid == resource.data.uid));
      // Only bishops can delete users (but not themselves).
      allow delete: if isSignedIn() && isBishop() && request.auth.uid != userId;
    }

    /**
     * @description Controls access to interview records.
     * @path /interviews/{interviewId}
     */
    match /interviews/{interviewId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Controls access to bishopric meeting records and their subcollections.
     * @path /bishopricMeetings/{meetingId}
     */
    match /bishopricMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /notes/{noteId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to sacrament meeting agenda records and their subcollections.
     * @path /sacramentMeetings/{meetingId}
     */
    match /sacramentMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /asuntosBarrio/{asuntoId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to log entries.
     * @path /logs/{logId}
     */
    match /logs/{logId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false;
    }
  }
}
