/**
 * @fileoverview Firestore Security Rules for the Ward Dashboard application.
 *
 * Core Philosophy:
 * This ruleset employs a hierarchical role-based access control model.
 * The user with the email 'ginorojoj@gmail.com' is the designated 'administrator' with full rights.
 * An 'administrator' can create 'bishops'.
 * 'Bishops' can create 'counselors' and 'secretaries'.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /interviews/{interviewId}: Stores interview records.
 * - /bishopricMeetings/{meetingId}: Stores bishopric meeting records.
 * - /sacramentMeetings/{meetingId}: Stores sacrament meeting agendas.
 * - /logs/{logId}: Stores user action logs.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdministrator() {
        // The user with this email is always an administrator.
        return request.auth.token.email == "ginorojoj@gmail.com";
    }

    function requestingUserRole() {
      return getUserData(request.auth.uid).role;
    }

    function isBishop() {
        return requestingUserRole() == 'bishop';
    }
    
    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Allow creation if the user is an admin, or a bishop creating a counselor/secretary.
      allow create: if isSignedIn() && (isAdministrator() || 
                      (isBishop() && request.resource.data.role in ['counselor', 'secretary']));

      // Admins and bishops can view user profiles. Users can view their own.
      allow get: if isSignedIn() && (isAdministrator() || isBishop() || isOwner(userId));
      
      // Admins and bishops can list all users.
      allow list: if isSignedIn() && (isAdministrator() || isBishop());

      // Update permissions:
      // - Admins can update any user.
      // - Bishops can update counselors/secretaries and themselves (but not their own role).
      // - Users can update their own profile (but not their role or UID).
      allow update: if isSignedIn() && (
                      isAdministrator() ||
                      (isBishop() && (getUserData(userId).role in ['counselor', 'secretary'] || (isOwner(userId) && request.resource.data.role == resource.data.role))) ||
                      (isOwner(userId) && request.resource.data.role == resource.data.role && request.resource.data.uid == resource.data.uid)
                    );

      // Only administrators can delete users. Bishops can delete counselors and secretaries.
      allow delete: if isSignedIn() && (isAdministrator() || (isBishop() && getUserData(userId).role in ['counselor', 'secretary']));
    }

    /**
     * @description Controls access to interview records.
     * @path /interviews/{interviewId}
     */
    match /interviews/{interviewId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Controls access to bishopric meeting records and their subcollections.
     * @path /bishopricMeetings/{meetingId}
     */
    match /bishopricMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /notes/{noteId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to sacrament meeting agenda records and their subcollections.
     * @path /sacramentMeetings/{meetingId}
     */
    match /sacramentMeetings/{meetingId} {
      allow read, write: if isSignedIn();

      match /asuntosBarrio/{asuntoId} {
        allow read, write: if isSignedIn();
      }
    }

    /**
     * @description Controls access to log entries.
     * @path /logs/{logId}
     */
    match /logs/{logId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false;
    }
  }
}
